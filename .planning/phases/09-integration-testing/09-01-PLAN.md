---
phase: 09-integration-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/server.ts
  - src/index.ts
  - tests/integration/helpers/setup.ts
  - tests/integration/server.test.ts
autonomous: true

must_haves:
  truths:
    - "MCP client can list both tools (multi_edit, multi_edit_files) via protocol"
    - "MCP client can call multi_edit and get structured success response"
    - "MCP client can call multi_edit_files and get structured success response"
    - "Error responses return isError: true with structured ErrorEnvelope"
    - "File edits are persisted to real filesystem through MCP protocol"
  artifacts:
    - path: "src/server.ts"
      provides: "Server factory function"
      exports: ["createServer"]
    - path: "src/index.ts"
      provides: "Entry point importing createServer"
      contains: "import.*createServer.*from.*server"
    - path: "tests/integration/helpers/setup.ts"
      provides: "Test helpers: createTestClient, createTempDir, createTestFile, cleanupTempDir, parseToolResult"
      exports: ["createTestClient", "createTempDir", "createTestFile", "cleanupTempDir", "parseToolResult"]
    - path: "tests/integration/server.test.ts"
      provides: "MCP protocol integration tests"
      min_lines: 150
  key_links:
    - from: "tests/integration/server.test.ts"
      to: "src/server.ts"
      via: "createTestClient -> createServer -> InMemoryTransport"
      pattern: "createTestClient"
    - from: "src/index.ts"
      to: "src/server.ts"
      via: "import createServer"
      pattern: "import.*createServer"
    - from: "tests/integration/server.test.ts"
      to: "real filesystem"
      via: "mkdtemp temp directories"
      pattern: "createTempDir|createTestFile"
---

<objective>
Extract server factory for testability, create integration test helpers, and implement MCP protocol-level integration tests verifying the complete request/response cycle for both tools.

Purpose: Satisfy TEST-03 (integration tests for MCP server) by testing the full MCP protocol path -- tool discovery, tool invocation, response parsing, and real filesystem mutations -- using the SDK's InMemoryTransport for in-process testing.

Output: `src/server.ts` (server factory), updated `src/index.ts`, test helpers module, and comprehensive `server.test.ts` with passing MCP protocol integration tests.
</objective>

<execution_context>
@/Users/dev/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-integration-testing/09-RESEARCH.md
@src/index.ts
@src/tools/multi-edit.ts
@src/tools/multi-edit-files.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract server factory and create test helpers</name>
  <files>
    src/server.ts
    src/index.ts
    tests/integration/helpers/setup.ts
  </files>
  <action>
**Step 1: Create `src/server.ts`** -- Extract all server creation logic from `src/index.ts`.

Move the following from `index.ts` into a new `src/server.ts` file:
- All imports (Server, CallToolRequestSchema, ListToolsRequestSchema, handleMultiEdit, handleMultiEditFiles, createErrorEnvelope, classifyError)
- The TOOLS array definition (lines 32-132 of current index.ts)
- A `createServer()` function that:
  - Creates and returns a `Server` instance with `{ name: 'eais-mcp-multi-edit', version: '1.0.0' }` and `{ capabilities: { tools: {} } }`
  - Registers ListToolsRequestSchema handler returning `{ tools: TOOLS }`
  - Registers CallToolRequestSchema handler with the same routing logic (multi_edit, multi_edit_files, unknown tool error, catch-all error)
- Export `createServer` as a named export

**Step 2: Simplify `src/index.ts`** -- Replace the inline server code with:
```typescript
#!/usr/bin/env node
import { StdioServerTransport } from '@modelcontextprotocol/sdk/server/stdio.js';
import { createServer } from './server.js';

const server = createServer();

async function main() {
  const transport = new StdioServerTransport();
  await server.connect(transport);
  console.error('EAIS MCP Multi-Edit Server running on stdio');
}

main().catch(console.error);
```

**Step 3: Verify refactoring** -- Run `npm run build` to confirm TypeScript compiles. Run `npm test` to confirm existing tests still pass.

**Step 4: Create `tests/integration/helpers/setup.ts`** with these exports:

- `createTestClient()`: Creates a Server via `createServer()`, creates linked `InMemoryTransport` pair via `InMemoryTransport.createLinkedPair()`, connects server to serverTransport, creates Client `{ name: 'integration-test-client', version: '1.0.0' }`, connects client to clientTransport. Returns `{ client, cleanup }` where cleanup closes the client transport.
  - Import `Client` from `@modelcontextprotocol/sdk/client/index.js`
  - Import `InMemoryTransport` from `@modelcontextprotocol/sdk/inMemory.js`
  - Connect server FIRST, then client (client initiates handshake)

- `createTempDir()`: Creates temp dir via `mkdtemp(join(tmpdir(), 'mcp-integ-'))` then calls `realpath()` on it (macOS /tmp symlink resolution). Returns resolved absolute path.

- `createTestFile(dir, name, content)`: Writes file at `join(dir, name)` with UTF-8 encoding. Returns full resolved path.

- `cleanupTempDir(dir)`: Calls `rm(dir, { recursive: true, force: true })`.

- `parseToolResult(result)`: Helper that takes a callTool result, extracts `result.content[0].text`, JSON.parses it, and returns `{ parsed, isError: result.isError }`. Use type assertion `(result.content as Array<{type: string; text: string}>)[0].text` for the SDK's union type.
  </action>
  <verify>
Run `npm run build` (must succeed -- confirms server.ts compiles and index.ts imports correctly).
Run `npm test` (existing tests must still pass -- no behavioral change from refactoring).
  </verify>
  <done>
`src/server.ts` exports `createServer()`, `src/index.ts` is simplified to ~10 lines importing from server.ts, `tests/integration/helpers/setup.ts` exports all 5 helper functions, build succeeds, existing tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: MCP protocol integration tests</name>
  <files>
    tests/integration/server.test.ts
  </files>
  <action>
Replace the existing `.todo` stubs in `tests/integration/server.test.ts` with real MCP protocol integration tests. Import helpers from `./helpers/setup.js`. Use `beforeEach` to create a test client and temp dir, `afterEach` to clean up both.

**Tool Discovery tests (describe 'tool discovery'):**
1. `should list both tools` -- `client.listTools()`, expect 2 tools, names contain 'multi_edit' and 'multi_edit_files'
2. `should expose correct input schema for multi_edit` -- find multi_edit tool from listTools, verify `inputSchema.required` contains 'file_path' and 'edits'
3. `should expose correct input schema for multi_edit_files` -- find multi_edit_files tool, verify `inputSchema.required` contains 'files'

**multi_edit tool tests (describe 'multi_edit tool'):**
4. `should apply single edit and modify file on disk` -- Create test file "hello world", call multi_edit replacing 'hello' -> 'goodbye' with `backup: false`. Assert `isError` falsy, parsed `success` true, `edits_applied` is 1. Read file from disk, assert content is 'goodbye world'.
5. `should apply multiple edits sequentially` -- Create file "aaa bbb ccc", apply edits [{old:'aaa', new:'xxx'}, {old:'bbb', new:'yyy'}] with backup:false. Assert success, edits_applied 2. Read file, assert 'xxx yyy ccc'.
6. `should support dry_run mode without modifying file` -- Create file "original", call multi_edit with `dry_run: true, backup: false`, edit 'original'->'modified'. Assert success. Read file from disk, assert still 'original'.
7. `should create backup file when backup is true` -- Create file "before edit", call multi_edit with backup:true (or omit, default is true), edit 'before'->'after'. Assert success. Read `.bak` file from dir (use glob or readdir), assert backup content is 'before edit'. Read original file, assert 'after edit'.
8. `should return error for non-existent file` -- Call multi_edit with path `join(tempDir, 'nonexistent.txt')`. Assert `isError` true, parsed `error_code` is 'VALIDATION_FAILED' (caught by validator file existence check).
9. `should return error when old_string not found` -- Create file "hello world", try to replace 'missing_string'. Assert `isError` true, check the parsed response indicates match failure.
10. `should return error for unknown tool name` -- Call `client.callTool({ name: 'nonexistent_tool', arguments: {} })`. Assert `isError` true, parsed `error_code` is 'UNKNOWN_TOOL'.

**multi_edit_files tool tests (describe 'multi_edit_files tool'):**
11. `should edit multiple files successfully` -- Create 2 files ('file1.txt': 'aaa', 'file2.txt': 'bbb'). Call multi_edit_files with edits for both files. Assert success, both files modified on disk.
12. `should rollback all files when one fails` -- Create file1.txt 'aaa'. Call multi_edit_files with file1 (valid edit aaa->xxx) and file2 pointing to non-existent path. Assert isError true. Read file1.txt, assert still 'aaa' (rolled back). Check response has `rollback` field.
13. `should support dry_run for multi-file` -- Create 2 files, call multi_edit_files with `dry_run: true`. Assert success. Read both files, assert unchanged.

All tests must use real filesystem via temp directories. Use `backup: false` where backup behavior is not the subject under test to keep temp dirs clean.
  </action>
  <verify>
Run `npx vitest run tests/integration/server.test.ts` -- all tests must pass.
Run `npm test` -- full suite must pass (no regressions).
  </verify>
  <done>
`tests/integration/server.test.ts` contains 13 passing MCP protocol integration tests covering tool discovery (3), multi_edit tool (7), and multi_edit_files tool (3). All tests exercise the full MCP Client -> InMemoryTransport -> Server -> Handler -> real filesystem path.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds (server.ts compiles, index.ts refactored correctly)
2. `npx vitest run tests/integration/server.test.ts` -- all 13 tests pass
3. `npm test` -- full test suite passes (existing unit tests + new integration tests)
4. Server factory extraction is behavioral no-op: existing `npm run dev` / stdio connection still works
</verification>

<success_criteria>
- createServer() is exported from src/server.ts and used by src/index.ts
- Integration tests verify complete MCP request/response cycle via Client + InMemoryTransport
- Tests use real filesystem temp directories (not memfs)
- All 13 integration tests pass
- No regressions in existing test suite
</success_criteria>

<output>
After completion, create `.planning/phases/09-integration-testing/09-01-SUMMARY.md`
</output>
