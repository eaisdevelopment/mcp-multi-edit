---
phase: 09-integration-testing
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - tests/integration/edge-cases.test.ts
autonomous: true

must_haves:
  truths:
    - "Unicode content (CJK, emoji, accented characters) is preserved through edit cycle"
    - "Large files (1MB+) are handled correctly without timeout"
    - "Empty edits array is rejected with VALIDATION_FAILED error"
    - "Replace-all flag replaces every occurrence"
    - "Ambiguous match (multiple matches without replace_all) returns error"
    - "Files with Windows line endings (CRLF) are handled correctly"
    - "No-op edits (old_string === new_string) succeed silently"
  artifacts:
    - path: "tests/integration/edge-cases.test.ts"
      provides: "Edge case integration tests with real filesystem"
      min_lines: 200
  key_links:
    - from: "tests/integration/edge-cases.test.ts"
      to: "src/tools/multi-edit.ts"
      via: "handleMultiEdit direct call"
      pattern: "handleMultiEdit"
    - from: "tests/integration/edge-cases.test.ts"
      to: "src/tools/multi-edit-files.ts"
      via: "handleMultiEditFiles direct call"
      pattern: "handleMultiEditFiles"
    - from: "tests/integration/edge-cases.test.ts"
      to: "real filesystem"
      via: "mkdtemp temp directories"
      pattern: "createTempDir|createTestFile"
---

<objective>
Implement edge case integration tests covering unicode content, large files, empty edits, line ending preservation, replace_all, ambiguous matches, and no-op edits using real filesystem operations.

Purpose: Satisfy TEST-04 (edge case tests: unicode, large files, empty edits) by testing handler-level behavior with direct calls to handleMultiEdit/handleMultiEditFiles on real temp directory files, verifying correct behavior at content boundaries.

Output: `tests/integration/edge-cases.test.ts` with comprehensive edge case coverage, all tests passing.
</objective>

<execution_context>
@/Users/dev/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-integration-testing/09-RESEARCH.md
@.planning/phases/09-integration-testing/09-01-SUMMARY.md
@src/tools/multi-edit.ts
@src/tools/multi-edit-files.ts
@tests/integration/helpers/setup.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Edge case tests - content boundaries</name>
  <files>
    tests/integration/edge-cases.test.ts
  </files>
  <action>
Create `tests/integration/edge-cases.test.ts`. Import `handleMultiEdit` from `../../src/tools/multi-edit.js` and `handleMultiEditFiles` from `../../src/tools/multi-edit-files.js`. Import `createTempDir`, `createTestFile`, `cleanupTempDir` from `./helpers/setup.js`. Import `readFile` from `node:fs/promises`.

Use `beforeEach` to create temp dir, `afterEach` to clean up.

**Unicode tests (describe 'unicode content'):**
1. `should handle CJK characters` -- Create file with Chinese text `const greeting = "Hello, \u4e16\u754c!";`. Replace `Hello, \u4e16\u754c!` with `\u3053\u3093\u306b\u3061\u306f\u4e16\u754c!`. Verify file contains the Japanese replacement and other content preserved. Use `backup: false`.

2. `should handle emoji content` -- Create file with emoji `const rocket = "\ud83d\ude80 launch";`. Replace `\ud83d\ude80 launch` with `\ud83c\udf1f star`. Read file, verify contains `\ud83c\udf1f star`. Use `backup: false`.

3. `should handle accented characters` -- Create file `caf\u00e9 na\u00efve r\u00e9sum\u00e9`. Replace `caf\u00e9` with `coffee`. Read file, verify `coffee na\u00efve r\u00e9sum\u00e9`.

4. `should handle mixed unicode in multi-file edit` -- Create 2 files, one with CJK and one with emoji. Call `handleMultiEditFiles` editing both. Verify both files correctly modified.

**Large file tests (describe 'large files'):**
5. `should handle 1MB+ file correctly` -- Generate ~1MB file: 20000 lines of `line {i}: ${'x'.repeat(50)}`. Replace `line 10000:` with `REPLACED LINE 10000:`. Verify file still >1MB, contains replacement. Set `{ timeout: 15000 }` on the test. Use `backup: false`.

6. `should handle file with very long single line` -- Create file with single line of 100,000 characters. Replace a substring in the middle. Verify replacement applied. Use `backup: false`.

**Empty/minimal edits (describe 'empty and minimal edits'):**
7. `should reject empty edits array with VALIDATION_FAILED` -- Create file "content". Call handleMultiEdit with `edits: []`. Assert `isError: true`. Parse response, assert `error_code` is `VALIDATION_FAILED`. Read file, assert unchanged.

8. `should handle no-op edit (old_string === new_string)` -- Create file "hello world". Call handleMultiEdit with `{ old_string: 'hello', new_string: 'hello' }`. Assert `isError` falsy (success). Read file, assert unchanged. Use `backup: false`.

9. `should handle edit that produces empty file` -- Create file "delete me". Replace `delete me` with empty string `""`. Assert success. Read file, assert content is empty string `""`. Use `backup: false`.

**Line ending tests (describe 'line endings'):**
10. `should preserve Windows CRLF line endings` -- Create file with explicit CRLF: `"line1\r\nline2\r\nline3"`. Replace `line2` with `replaced`. Read file, verify content is `"line1\r\nreplaced\r\nline3"`. Use `backup: false`.

11. `should handle mixed line endings` -- Create file `"unix\nmixed\r\nfile"`. Replace `mixed` with `changed`. Read file, verify `"unix\nchanged\r\nfile"`. Use `backup: false`.

**Match behavior tests (describe 'match behavior'):**
12. `should replace all occurrences with replace_all flag` -- Create file `"aaa bbb aaa ccc aaa"`. Call with `{ old_string: 'aaa', new_string: 'xxx', replace_all: true }`. Read file, verify `"xxx bbb xxx ccc xxx"`. Use `backup: false`.

13. `should error on ambiguous match without replace_all` -- Create file `"aaa bbb aaa"`. Call with `{ old_string: 'aaa', new_string: 'xxx' }` (no replace_all). Assert `isError: true`. Parse response, check for match error indicating multiple occurrences. Read file, assert unchanged. Use `backup: false`.

14. `should handle path with spaces` -- Create temp file at `join(tempDir, 'file with spaces.txt')` with content `"hello"`. Call handleMultiEdit with that path. Assert success. Read file, verify edit applied. Use `backup: false`.

All tests call handlers directly (not via MCP Client) for efficiency. All use real filesystem via `createTempDir`/`createTestFile` helpers. Parse tool results via `JSON.parse(result.content[0].text)` with `result.isError` check on outer response.
  </action>
  <verify>
Run `npx vitest run tests/integration/edge-cases.test.ts` -- all 14 tests must pass.
Run `npm test` -- full suite must pass (no regressions).
  </verify>
  <done>
`tests/integration/edge-cases.test.ts` contains 14 passing edge case tests organized in 5 describe blocks: unicode content (4), large files (2), empty/minimal edits (3), line endings (2), match behavior (3). All tests use real filesystem temp directories. Full test suite passes.
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run tests/integration/edge-cases.test.ts` -- all 14 tests pass
2. `npm test` -- full suite passes (unit tests + server integration + edge cases)
3. Edge cases cover all TEST-04 requirements: unicode, large files, empty edits
4. All tests use real filesystem (temp directories), not memfs
</verification>

<success_criteria>
- Unicode content (CJK, emoji, accented) correctly handled through edit cycle
- Large files (1MB+) processed without timeout
- Empty edits array rejected with VALIDATION_FAILED
- Windows CRLF line endings preserved
- Replace-all and ambiguous match behaviors verified
- No-op edits succeed silently
- All 14 edge case tests pass
- Full test suite has zero regressions
</success_criteria>

<output>
After completion, create `.planning/phases/09-integration-testing/09-02-SUMMARY.md`
</output>
