---
phase: 08-unit-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/unit/editor-pure.test.ts
  - tests/unit/validator-pure.test.ts
autonomous: true

must_haves:
  truths:
    - "Pure editor functions have direct tests covering edge cases, error paths, and normal operations"
    - "Pure validator functions have direct tests covering path validation, duplicate detection, and Zod error formatting"
    - "All new pure-logic tests pass via npm test without any filesystem mocking"
  artifacts:
    - path: "tests/unit/editor-pure.test.ts"
      provides: "Direct unit tests for editor.ts pure functions"
      min_lines: 100
    - path: "tests/unit/validator-pure.test.ts"
      provides: "Direct unit tests for validator.ts pure/sync functions"
      min_lines: 80
  key_links:
    - from: "tests/unit/editor-pure.test.ts"
      to: "src/core/editor.ts"
      via: "static imports"
      pattern: "import.*from.*editor"
    - from: "tests/unit/validator-pure.test.ts"
      to: "src/core/validator.ts"
      via: "static imports"
      pattern: "import.*from.*validator"
---

<objective>
Write comprehensive unit tests for all pure (non-IO) functions in editor.ts and validator.ts.

Purpose: Close coverage gaps in pure logic that requires no filesystem mocking -- formatFileError (0% covered), formatBackupError (0% covered), validatePath (0% covered), detectDuplicateOldStrings (0% covered), formatZodErrors (0% covered), and add edge-case coverage for getLineNumber, findAllMatchPositions, getMatchLineNumbers, replaceStringCaseAware.

Output: Two new test files with comprehensive pure-function test coverage.
</objective>

<execution_context>
@/Users/dev/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-unit-testing/08-RESEARCH.md
@src/core/editor.ts
@src/core/validator.ts
@src/types/index.ts
@tests/unit/editor.test.ts
@tests/unit/validator.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Pure editor function tests</name>
  <files>tests/unit/editor-pure.test.ts</files>
  <action>
Create `tests/unit/editor-pure.test.ts` with direct unit tests for these editor.ts pure functions. Use top-level static imports (NOT dynamic `await import()` pattern from existing tests -- these are pure functions with no mocking needed).

Import these functions:
```typescript
import { describe, it, expect } from 'vitest';
import {
  getLineNumber,
  findAllMatchPositions,
  getMatchLineNumbers,
  replaceStringCaseAware,
  formatFileError,
  formatBackupError,
} from '../../src/core/editor.js';
```

**getLineNumber** (4-5 tests):
- charIndex 0 in single-line content returns line 1
- charIndex after first newline returns line 2
- charIndex at exact newline position
- charIndex at end of multi-line content returns correct line
- empty content with charIndex 0

**findAllMatchPositions** (5-6 tests):
- Empty searchString returns []
- Single match returns [position]
- Multiple matches returns all positions
- No match returns []
- Case-insensitive: 'Hello' with 'hello' and caseInsensitive=true finds match
- Case-insensitive: with multiple case-variant matches

**getMatchLineNumbers** (3-4 tests):
- Single match returns [line number]
- Matches on different lines return correct line numbers
- No matches returns []
- Case-insensitive match returns correct lines

**replaceStringCaseAware** (6-7 tests):
- Empty oldString returns content unchanged, replacedCount=0
- No match returns content unchanged, replacedCount=0
- Single replacement (replaceAll=false) replaces first occurrence only, replacedCount=1
- replaceAll=true replaces all occurrences
- Case-insensitive single replacement
- Case-insensitive replaceAll
- replaceAll + case-insensitive combo with mixed-case matches

**formatFileError** (5 tests -- currently 0% coverage):
- Error with code 'ENOENT' returns message containing 'File not found'
- Error with code 'EACCES' returns message containing 'Permission denied'
- Error with code 'EPERM' returns message containing 'Permission denied'
- Error with message containing 'UTF-8' passes through unchanged
- Non-Error value (string) returns 'Unknown file error' message

Construct errno-style errors like this:
```typescript
const error = Object.assign(new Error('ENOENT: no such file'), { code: 'ENOENT' });
```

**formatBackupError** (5 tests -- currently 0% coverage):
- Error with code 'EACCES' returns message containing 'Permission denied'
- Error with code 'EPERM' returns message containing 'Permission denied'
- Error with code 'ENOSPC' returns message containing 'No space left'
- Error with code 'EROFS' returns message containing 'Read-only file system'
- Non-Error value returns 'Unknown error' message

For formatBackupError, verify the backupPath appears in the returned message.
  </action>
  <verify>Run `npm test -- tests/unit/editor-pure.test.ts` and confirm all tests pass.</verify>
  <done>All ~28-33 tests in editor-pure.test.ts pass. formatFileError and formatBackupError have direct coverage (previously 0%).</done>
</task>

<task type="auto">
  <name>Task 2: Pure validator function tests</name>
  <files>tests/unit/validator-pure.test.ts</files>
  <action>
Create `tests/unit/validator-pure.test.ts` with direct unit tests for these validator.ts pure/sync functions. Use top-level static imports.

Import these functions:
```typescript
import { describe, it, expect } from 'vitest';
import {
  validatePath,
  detectDuplicateOldStrings,
  formatZodErrors,
  MultiEditInputSchema,
  MultiEditFilesInputSchema,
} from '../../src/core/validator.js';
```

**validatePath** (5-6 tests -- currently 0% coverage):
- Valid absolute path '/home/user/file.ts' returns null
- Relative path 'relative/path.ts' returns ValidationError with code 'RELATIVE_PATH'
- Path with '..' like '/home/user/../etc/passwd' returns ValidationError with code 'PATH_TRAVERSAL'
- Path starting with './' returns RELATIVE_PATH error
- All returned errors have recovery_hint defined
- Root path '/' returns null (valid absolute)

**detectDuplicateOldStrings** (4-5 tests -- currently 0% coverage):
- Unique old_strings returns empty array
- Single duplicate pair returns 1 error with code 'DUPLICATE_OLD_STRING'
- Verify error path is ['edits', '{index}', 'old_string'] with correct index
- Multiple different duplicates returns multiple errors
- Three identical old_strings returns 2 errors (second and third flagged)

**formatZodErrors** (5-6 tests -- currently 0% coverage):
Use `safeParse` to generate real ZodError objects, then pass to formatZodErrors:
- Empty edits array: parse `{ file_path: '/test.ts', edits: [] }` with MultiEditInputSchema, verify formatZodErrors returns error with code starting with 'SCHEMA_'
- Empty old_string: parse `{ file_path: '/f.ts', edits: [{ old_string: '', new_string: 'x' }] }`, verify code is 'SCHEMA_TOO_SMALL' and recovery_hint mentions old_string
- Missing required field (file_path): parse `{ edits: [{ old_string: 'a', new_string: 'b' }] }`, verify returns SCHEMA_INVALID_TYPE error
- Wrong type (file_path as number): parse `{ file_path: 123, edits: [...] }`, verify returns SCHEMA_INVALID_TYPE with recovery_hint mentioning expected type
- All errors have recovery_hint defined
- Test with MultiEditFilesInputSchema: empty files array generates error with 'SCHEMA_TOO_SMALL' code

**MultiEditInputSchema defaults** (3-4 tests -- extend existing coverage):
- Verify include_content defaults to false
- Verify backup defaults to true
- Verify dry_run defaults to false
- Verify replace_all per-edit defaults to false

Do NOT test Zod's own type validation mechanics (like "number rejects string") -- test that OUR schemas encode the right constraints.
  </action>
  <verify>Run `npm test -- tests/unit/validator-pure.test.ts` and confirm all tests pass.</verify>
  <done>All ~17-21 tests in validator-pure.test.ts pass. validatePath, detectDuplicateOldStrings, and formatZodErrors have direct coverage (previously 0%).</done>
</task>

</tasks>

<verification>
Run full test suite: `npm test`
All existing tests still pass (no regressions).
All new tests in editor-pure.test.ts and validator-pure.test.ts pass.
</verification>

<success_criteria>
- editor-pure.test.ts exists with 28+ passing tests
- validator-pure.test.ts exists with 17+ passing tests
- formatFileError, formatBackupError, validatePath, detectDuplicateOldStrings, formatZodErrors all have direct test coverage
- `npm test` passes with zero failures
</success_criteria>

<output>
After completion, create `.planning/phases/08-unit-testing/08-01-SUMMARY.md`
</output>
