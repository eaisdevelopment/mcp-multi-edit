---
phase: 04-dry-run-mode
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/reporter.ts
  - src/tools/multi-edit.ts
autonomous: true

must_haves:
  truths:
    - "User sees 'DRY RUN' label in response when dry_run=true"
    - "User sees unified diff preview showing what would change"
    - "File content is unchanged after dry_run=true operation"
    - "Dry-run returns same success/failure status as real run would"
  artifacts:
    - path: "src/core/reporter.ts"
      provides: "Enhanced dry-run response formatting with diff preview"
      exports: ["formatMultiEditResponse", "generateDiffPreview"]
    - path: "src/tools/multi-edit.ts"
      provides: "Handler passes original content to reporter for diff"
      contains: "generateDiffPreview"
  key_links:
    - from: "src/tools/multi-edit.ts"
      to: "src/core/reporter.ts"
      via: "generateDiffPreview call for dry-run"
      pattern: "generateDiffPreview\\("
    - from: "src/core/reporter.ts"
      to: "formatMultiEditResponse"
      via: "diff_preview field in SuccessResponse"
      pattern: "diff_preview"
---

<objective>
Enhance dry-run mode to provide clear visual feedback and diff previews.

Purpose: When users set dry_run=true, they should get clear indication that no changes were made plus a diff showing what WOULD change. This enables confident verification before committing to edits.
Output: Enhanced reporter with diff preview integration, handler wiring for dry-run context.
</objective>

<execution_context>
@/Users/dev/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@src/core/reporter.ts
@src/core/editor.ts
@src/tools/multi-edit.ts
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance reporter for dry-run responses with diff preview</name>
  <files>src/core/reporter.ts</files>
  <action>
Update src/core/reporter.ts to enhance dry-run responses:

1. Update SuccessResponse interface to include optional dry-run fields:
```typescript
export interface SuccessResponse {
  success: true;
  file_path: string;
  edits_applied: number;
  dry_run: boolean;
  message?: string;           // Add for dry-run messaging
  diff_preview?: string;      // Add for unified diff
  edits: Array<{
    old_string: string;
    matched: boolean;
    occurrences_replaced: number;
  }>;
  backup_path?: string;
  final_content?: string;
}
```

2. Update `formatMultiEditResponse` to accept optional `originalContent` parameter and generate diff for dry-runs:
```typescript
export function formatMultiEditResponse(
  result: MultiEditResult,
  includeContent: boolean,
  totalEdits: number,
  fileContent?: string,
  originalContent?: string  // Add this parameter
): SuccessResponse | ErrorResponse
```

3. In the success branch of `formatMultiEditResponse`, when `result.dry_run === true`:
   - Add `message: 'DRY RUN - No changes made to file'`
   - If `originalContent` and `result.final_content` are both available, call `generateDiffPreview()` and include the result in `diff_preview` field

4. Update the `generateDiffPreview` function to handle edge cases:
   - If original === new, return "No changes" instead of empty diff
   - Add line numbers to the diff output for easier reference
  </action>
  <verify>npm run build passes. Manually inspect that SuccessResponse type now has message and diff_preview fields.</verify>
  <done>SuccessResponse has message and diff_preview fields. formatMultiEditResponse generates diff preview for dry-run operations.</done>
</task>

<task type="auto">
  <name>Task 2: Wire handler to pass original content for dry-run diff</name>
  <files>src/tools/multi-edit.ts</files>
  <action>
Update src/tools/multi-edit.ts to provide original content for diff generation:

1. The handler already reads file content for context snippets:
```typescript
const fileContent = await readFile(input.file_path, 'utf-8');
```

2. Update the `formatMultiEditResponse` call to pass original content as the 5th parameter:
```typescript
const response = formatMultiEditResponse(
  result,
  input.include_content ?? false,
  input.edits.length,
  fileContent,
  fileContent  // Pass again as originalContent for diff comparison
);
```

Note: The file content is already read before edits are applied. When dry_run=true, applyEdits reads the file but doesn't write, so fileContent represents the original. For non-dry-run, the diff preview won't be shown anyway (message/diff_preview only added when dry_run=true).
  </action>
  <verify>npm run build passes. Test dry_run=true and verify response includes message and diff_preview fields.</verify>
  <done>Handler passes original content to reporter. Dry-run responses include 'DRY RUN' message and diff preview.</done>
</task>

<task type="auto">
  <name>Task 3: Verify dry-run file safety with manual test</name>
  <files>None (verification only)</files>
  <action>
Create a verification test to confirm file unchanged after dry-run:

1. Create a test file:
```bash
echo "line one\nline two\nline three" > /tmp/dry-run-test.txt
cat /tmp/dry-run-test.txt
```

2. Note the exact content and timestamp:
```bash
md5 /tmp/dry-run-test.txt
stat -f "%m" /tmp/dry-run-test.txt
```

3. Start the MCP server and send a dry-run request (or use npx tsx to run a quick test script):
```bash
# Create test script
cat > /tmp/test-dry-run.ts << 'EOF'
import { handleMultiEdit } from './src/tools/multi-edit.js';

async function test() {
  const result = await handleMultiEdit({
    file_path: '/tmp/dry-run-test.txt',
    edits: [
      { old_string: 'line two', new_string: 'LINE TWO MODIFIED' }
    ],
    dry_run: true
  });
  console.log(result.content[0].text);
}
test();
EOF
```

4. Run the test:
```bash
cd /path/to/project
npx tsx /tmp/test-dry-run.ts
```

5. Verify file unchanged:
```bash
cat /tmp/dry-run-test.txt
md5 /tmp/dry-run-test.txt  # Should match step 2
stat -f "%m" /tmp/dry-run-test.txt  # Timestamp should match step 2
```

6. Verify response contains:
   - `"dry_run": true`
   - `"message": "DRY RUN - No changes made to file"`
   - `"diff_preview"` showing the change that would have been made
  </action>
  <verify>File content, MD5, and timestamp unchanged after dry-run. Response shows dry-run message and diff preview.</verify>
  <done>Manual verification confirms dry-run does not modify files. Response includes clear dry-run indicator and diff preview.</done>
</task>

</tasks>

<verification>
1. Build: `npm run build` completes without errors
2. Dry-run response test: Call multi_edit with dry_run=true on existing file
   - Response includes `"message": "DRY RUN - No changes made to file"`
   - Response includes `"diff_preview"` with unified diff format
   - Response has `"dry_run": true`
3. File safety test: After dry_run=true call, verify file content unchanged (MD5 + timestamp match)
4. Error consistency test: Call multi_edit with dry_run=true and non-existent old_string
   - Should return same error format as non-dry-run would
</verification>

<success_criteria>
- Dry-run responses clearly labeled with "DRY RUN" message
- Diff preview shows what changes would be applied
- File content verified unchanged after dry-run operation
- Same success/failure behavior whether dry_run=true or false
- Build passes, no type errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-dry-run-mode/04-01-SUMMARY.md`
</output>
