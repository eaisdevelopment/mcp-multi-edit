---
phase: 02-single-file-tool-wiring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/index.ts
  - src/tools/multi-edit.ts
  - src/core/reporter.ts
  - src/core/validator.ts
  - src/types/index.ts
autonomous: true

must_haves:
  truths:
    - "Claude client can list tools and see multi_edit with include_content property"
    - "Claude client can call multi_edit and receive structured JSON success response"
    - "Claude client can call multi_edit with invalid input and receive error with recovery hint"
    - "Error responses include atomicity message (file unchanged)"
  artifacts:
    - path: "src/index.ts"
      provides: "MCP server with wired multi_edit handler"
      contains: "handleMultiEdit"
    - path: "src/tools/multi-edit.ts"
      provides: "Tool handler calling applyEdits and formatting response"
      exports: ["handleMultiEdit"]
    - path: "src/core/reporter.ts"
      provides: "Enhanced result formatting with include_content, recovery hints"
      exports: ["formatMultiEditResponse"]
    - path: "src/core/validator.ts"
      provides: "Validation schema with include_content field"
      contains: "include_content"
    - path: "src/types/index.ts"
      provides: "MultiEditInput type with include_content"
      contains: "include_content"
  key_links:
    - from: "src/index.ts"
      to: "src/tools/multi-edit.ts"
      via: "import handleMultiEdit"
      pattern: "import.*handleMultiEdit.*from.*tools/multi-edit"
    - from: "src/tools/multi-edit.ts"
      to: "src/core/editor.ts"
      via: "applyEdits call"
      pattern: "applyEdits\\("
    - from: "src/tools/multi-edit.ts"
      to: "src/core/reporter.ts"
      via: "formatMultiEditResponse call"
      pattern: "formatMultiEditResponse\\("
---

<objective>
Wire the multi_edit MCP tool handler to the Phase 1 editor engine and return structured JSON responses per CONTEXT.md decisions.

Purpose: Enable Claude to invoke multi_edit tool and receive actionable success/error responses with recovery hints.
Output: Working multi_edit tool that can be called via MCP protocol with proper response formatting.
</objective>

<execution_context>
@/Users/dev/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-single-file-tool-wiring/02-CONTEXT.md
@.planning/phases/02-single-file-tool-wiring/02-RESEARCH.md

# Source files to modify
@src/index.ts
@src/tools/multi-edit.ts
@src/core/reporter.ts
@src/core/validator.ts
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add include_content to types and validator</name>
  <files>src/types/index.ts, src/core/validator.ts</files>
  <action>
1. In `src/types/index.ts`, add to `MultiEditInput` interface:
   ```typescript
   /** Include final file content in response (default: false) */
   include_content?: boolean;
   ```

2. In `src/core/validator.ts`, add to `MultiEditInputSchema`:
   ```typescript
   include_content: z.boolean().optional().default(false),
   ```

This enables the optional include_content flag throughout the type system.
  </action>
  <verify>Run `npm run build` - should compile without errors</verify>
  <done>MultiEditInput type and Zod schema both include include_content field</done>
</task>

<task type="auto">
  <name>Task 2: Enhance reporter with response formatting</name>
  <files>src/core/reporter.ts</files>
  <action>
Update `src/core/reporter.ts` to implement CONTEXT.md response decisions:

1. Add new `formatMultiEditResponse` function that:
   - Takes `MultiEditResult` and `includeContent: boolean`
   - Returns structured object (not stringified yet - let caller stringify)

2. For SUCCESS responses, return:
   ```typescript
   {
     success: true,
     file_path: string,
     edits_applied: number,
     dry_run: boolean,
     edits: Array<{
       old_string: string,  // truncated to 50 chars if longer
       matched: boolean,
       occurrences_replaced: number
     }>,
     backup_path?: string,        // if backup was created
     final_content?: string       // only if includeContent=true
   }
   ```

3. For ERROR responses, return:
   ```typescript
   {
     success: false,
     file_path: string,
     error: string,
     failed_edit_index?: number,
     edits_applied: 0,
     message: "Operation failed. No changes applied - file unchanged.",
     recovery_hint: string  // from getRecoveryHint()
   }
   ```

4. Add `getRecoveryHint(error: string): string` function:
   - "not found" → "Read the file to see current content, then retry with correct old_string."
   - "Permission denied" → "Check file permissions."
   - "matches at lines" → "Use replace_all: true or make old_string more specific."
   - "UTF-8" → "Ensure file uses UTF-8 encoding."
   - default → "Check error details and retry."

5. Add `truncateForDisplay(str: string, maxLen: number): string` helper.

Keep existing functions for backward compatibility (they're used by existing tests).
  </action>
  <verify>Run `npm run build` - should compile without errors</verify>
  <done>formatMultiEditResponse returns structured objects with recovery hints and atomicity message</done>
</task>

<task type="auto">
  <name>Task 3: Wire handler to MCP server</name>
  <files>src/tools/multi-edit.ts, src/index.ts</files>
  <action>
1. Update `src/tools/multi-edit.ts`:
   - Import `formatMultiEditResponse` from reporter (add to existing imports)
   - Update `handleMultiEdit` to:
     a. Extract `include_content` from validated input (default false)
     b. Call `formatMultiEditResponse(result, input.include_content ?? false)`
     c. Return `JSON.stringify(response, null, 2)` in text field
   - Remove `createErrorResult` import if no longer needed

2. Update `src/index.ts`:
   - Uncomment import: `import { handleMultiEdit } from './tools/multi-edit.js';`
   - In CallToolRequestSchema handler, replace the multi_edit stub:
     ```typescript
     if (name === 'multi_edit') {
       return await handleMultiEdit(args);
     }
     ```
   - Add `include_content` property to TOOLS[0].inputSchema.properties:
     ```typescript
     include_content: {
       type: 'boolean',
       description: 'Include final file content in response (default: false, use for verification)',
     },
     ```
  </action>
  <verify>
Run `npm run build` - should compile without errors.
Run `npm test` - existing tests should still pass.
  </verify>
  <done>multi_edit tool is wired end-to-end: MCP server routes to handler, handler calls applyEdits, response is formatted per CONTEXT.md</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Build succeeds: `npm run build`
2. Tests pass: `npm test`
3. Tool schema includes include_content:
   ```bash
   grep -A2 "include_content" src/index.ts
   ```
4. Handler is imported and used:
   ```bash
   grep "handleMultiEdit" src/index.ts
   ```
5. Recovery hints exist in reporter:
   ```bash
   grep "recovery_hint\|getRecoveryHint" src/core/reporter.ts
   ```
</verification>

<success_criteria>
Phase 2 requirements satisfied (MCP-01, MCP-03, MCP-04):
- [MCP-01] multi_edit tool registered with proper schema (including include_content)
- [MCP-03] ListToolsRequest returns multi_edit in tools array
- [MCP-04] CallToolRequest routes to handleMultiEdit and returns structured response

User observable truths:
- Claude can list tools and see multi_edit with correct schema
- Claude can call multi_edit and receive JSON response with success/edits_applied
- Error responses include recovery hints and atomicity message
</success_criteria>

<output>
After completion, create `.planning/phases/02-single-file-tool-wiring/02-01-SUMMARY.md`
</output>
