---
phase: 10-coverage-completion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/unit/errors-pure.test.ts
  - tests/unit/reporter-pure.test.ts
  - src/core/reporter.ts
autonomous: true

must_haves:
  truths:
    - "errors.ts pure functions (classifyError, getRecoveryHints, extractFileContext, extractMatchLocations, buildEditStatus, createErrorEnvelope) all have direct unit tests"
    - "reporter.ts formatting functions (formatMultiEditResponse error paths, generateDiffPreview no-change branch, truncateForDisplay, formatMultiEditFilesResponse includeContent=true) all have direct unit tests"
    - "Dead code in reporter.ts (formatMultiEditResult, formatMultiEditFilesResult, createSuccessResult, createErrorResult, createFilesErrorResult) is removed"
    - "errors.ts coverage rises from 50% to 90%+"
    - "reporter.ts coverage rises from 78% to 90%+"
  artifacts:
    - path: "tests/unit/errors-pure.test.ts"
      provides: "Unit tests for all errors.ts pure functions"
      min_lines: 150
    - path: "tests/unit/reporter-pure.test.ts"
      provides: "Unit tests for reporter.ts formatting functions"
      min_lines: 100
    - path: "src/core/reporter.ts"
      provides: "Reporter module with dead code removed"
  key_links:
    - from: "tests/unit/errors-pure.test.ts"
      to: "src/core/errors.ts"
      via: "direct import"
      pattern: "import.*from.*errors"
    - from: "tests/unit/reporter-pure.test.ts"
      to: "src/core/reporter.ts"
      via: "direct import"
      pattern: "import.*from.*reporter"
---

<objective>
Test all pure functions in errors.ts and reporter.ts, and remove confirmed dead code from reporter.ts.

Purpose: These two files have the largest coverage gaps (errors.ts at 50%, reporter.ts at 78%). All uncovered code is pure functions that can be tested with simple input/output assertions -- no filesystem mocking needed. Removing 5 dead functions from reporter.ts reduces the coverage denominator.

Output: Two new test files, reporter.ts cleaned of dead code, errors.ts and reporter.ts both at 90%+ coverage.
</objective>

<execution_context>
@/Users/dev/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-coverage-completion/10-RESEARCH.md
@src/core/errors.ts
@src/core/reporter.ts
@src/core/editor.ts
@src/types/index.ts
@tests/unit/editor-pure.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove dead code from reporter.ts and test errors.ts pure functions</name>
  <files>src/core/reporter.ts, tests/unit/errors-pure.test.ts</files>
  <action>
**Part A: Remove dead code from reporter.ts**

Remove these 5 functions that are confirmed unused (grep confirms no imports anywhere in the codebase):
- `formatMultiEditResult()` (L31-33)
- `formatMultiEditFilesResult()` (L38-40)
- `createSuccessResult()` (L45-59)
- `createErrorResult()` (L64-79)
- `createFilesErrorResult()` (L130-143)

Keep all other functions intact. After removal, verify the build still compiles: `npm run build`.

**Part B: Create tests/unit/errors-pure.test.ts**

Test all pure functions from `src/core/errors.ts` with direct imports (same pattern as editor-pure.test.ts):

1. **classifyError()** (~10 tests):
   - Error with `code: 'ENOENT'` -> `FILE_NOT_FOUND`
   - Error with `code: 'EACCES'` -> `PERMISSION_DENIED`
   - Error with `code: 'EPERM'` -> `PERMISSION_DENIED`
   - Error with `code: 'ENOSPC'` -> `DISK_FULL`
   - Error with `code: 'EROFS'` -> `READ_ONLY_FS`
   - Error with `code: 'ELOOP'` -> `SYMLINK_LOOP`
   - Error with message containing 'utf-8' -> `INVALID_ENCODING`
   - Error with message containing 'encoding' -> `INVALID_ENCODING`
   - Generic Error (no code) -> `UNKNOWN_ERROR`
   - Non-Error value (string) with filePath -> `UNKNOWN_ERROR` with message containing filePath
   - Non-Error value (string) without filePath -> `UNKNOWN_ERROR` with 'Unknown error'
   - Construct errno errors with: `Object.assign(new Error('msg'), { code: 'ENOENT' })`

2. **getRecoveryHints()** (~18 tests, one per switch case):
   - Test each ErrorCode returns a non-empty array of strings
   - Test `MATCH_NOT_FOUND` returns 2 hints (whitespace and re-read)
   - Test `AMBIGUOUS_MATCH` returns 2 hints (replace_all and more specific)
   - Test `FILE_NOT_FOUND`, `PERMISSION_DENIED`, `VALIDATION_FAILED`, `RELATIVE_PATH`, `PATH_TRAVERSAL`, `EMPTY_EDITS`, `EMPTY_OLD_STRING`, `DUPLICATE_OLD_STRING`, `DUPLICATE_FILE_PATH`, `INVALID_ENCODING`, `DISK_FULL`, `READ_ONLY_FS`, `SYMLINK_LOOP`, `BACKUP_FAILED`, `WRITE_FAILED`, `UNKNOWN_TOOL`, `NOT_IMPLEMENTED`
   - Test default case with `'UNKNOWN_ERROR'` returns ['Check error details and retry']

3. **extractFileContext()** (~5 tests):
   - Empty string input -> returns `{}`
   - File content with partial match at 20-char prefix -> returns snippet around match
   - File content with partial match at 10-char prefix (search < 20 chars) -> returns snippet
   - File content with short search string (< 5 chars) -> uses full search string
   - No match found at all -> returns first 15 lines as snippet

4. **extractMatchLocations()** (~4 tests):
   - Empty positions array -> returns `{}`
   - 2 positions -> returns `match_locations` with 2 entries, each having line and snippet
   - 6+ positions -> returns only first 5, plus `snippet` field with "5 of N matches shown"
   - Verify line numbers are 1-based

5. **buildEditStatus()** (~3 tests):
   - Single edit fails at index 0 -> 1 entry with status 'failed'
   - Edit at index 1 of 3 fails -> index 1 'failed', index 2 'skipped'
   - All entries have `old_string_preview` truncated to 40 chars

6. **createErrorEnvelope()** (~4 tests):
   - Minimal args (error_code + message) -> has success:false, retryable, recovery_hints
   - With all optional fields (file_path, edit_index, context, edit_status, backup_path) -> all present
   - Without optional fields -> those keys absent from envelope (not undefined, absent)
   - Retryable code (MATCH_NOT_FOUND) -> retryable: true; non-retryable (UNKNOWN_ERROR) -> retryable: false

7. **isRetryable() + RETRYABLE_CODES** (~2 tests):
   - Test MATCH_NOT_FOUND is retryable
   - Test UNKNOWN_ERROR is not retryable

Import pattern: `import { classifyError, getRecoveryHints, extractFileContext, extractMatchLocations, buildEditStatus, createErrorEnvelope, isRetryable, RETRYABLE_CODES } from '../../src/core/errors.js';`
  </action>
  <verify>
Run `npm run build` to verify reporter.ts still compiles after dead code removal.
Run `npx vitest run tests/unit/errors-pure.test.ts` -- all tests pass.
Run `npx vitest run --coverage` and check errors.ts coverage is 90%+.
  </verify>
  <done>
errors.ts has 40+ passing unit tests covering all pure functions and all switch branches.
reporter.ts has 5 dead functions removed with clean build.
errors.ts coverage is 90%+ on all 4 metrics.
  </done>
</task>

<task type="auto">
  <name>Task 2: Test reporter.ts formatting functions</name>
  <files>tests/unit/reporter-pure.test.ts</files>
  <action>
Create tests/unit/reporter-pure.test.ts testing reporter.ts exported functions.

Import pattern: `import { formatMultiEditResponse, generateDiffPreview, truncateForDisplay, formatMultiEditFilesResponse, createFilesSuccessResult } from '../../src/core/reporter.js';`
Also import types: `import type { MultiEditResult, MultiEditFilesResult } from '../../src/types/index.js';`

1. **truncateForDisplay()** (~3 tests):
   - String shorter than maxLen -> returns unchanged
   - String exactly maxLen -> returns unchanged
   - String longer than maxLen -> returns truncated with '...' suffix (length = maxLen)

2. **generateDiffPreview()** (~3 tests):
   - originalContent === newContent -> returns 'No changes'
   - Single line changed -> output contains `--- path (original)`, `+++ path (modified)`, `L1: - old`, `L1: + new`
   - Lines added (newContent has more lines) -> shows `L{n}: + newline`

3. **formatMultiEditResponse() success paths** (~3 tests):
   - Success result -> SuccessResponse with edits array, each having old_string (truncated), matched, occurrences_replaced
   - Success with dry_run=true and originalContent+final_content -> has message 'DRY RUN' and diff_preview
   - Success with includeContent=true and final_content -> response.final_content present
   - Success with backup_path -> response.backup_path present

4. **formatMultiEditResponse() error paths** (~5 tests):
   These test the private `classifyErrorFromMessage()` indirectly through `formatMultiEditResponse()`:

   - Result with `error: 'old_string not found in file'` -> ErrorEnvelope with error_code 'MATCH_NOT_FOUND', and context.snippet populated from fileContent
   - Result with `error: '2 matches at lines 5, 10'` and fileContent with 2 matches -> ErrorEnvelope with error_code 'AMBIGUOUS_MATCH' and context.match_locations array
   - Result with `error: 'permission denied eacces'` -> error_code 'PERMISSION_DENIED'
   - Result with `error: 'invalid utf-8 encoding'` -> error_code 'INVALID_ENCODING'
   - Result with `error: 'backup failed'` -> error_code 'BACKUP_FAILED'
   - Result with `error: 'something unknown'` -> error_code 'UNKNOWN_ERROR'
   - Error result with `edits` param provided -> edit_status populated in envelope
   - Error result without fileContent -> no context field

   For each error test, construct a `MultiEditResult` with `success: false`, appropriate `error` string, `failed_edit_index: 0`, and `results` with at least one entry containing `old_string` matching the error scenario.

   For MATCH_NOT_FOUND context, provide `fileContent` with content where the old_string is NOT found (to verify extractFileContext returns first 15 lines as fallback).

   For AMBIGUOUS_MATCH context, provide `fileContent` containing the old_string twice so `findAllMatchPositions()` returns 2 positions.

5. **formatMultiEditFilesResponse()** (~2 tests):
   - With includeContent=false -> final_content stripped from each file_result
   - With includeContent=true -> final_content preserved

6. **createFilesSuccessResult()** (~1 test):
   - Verify summary field has correct total_files, files_succeeded, files_failed, total_edits
  </action>
  <verify>
Run `npx vitest run tests/unit/reporter-pure.test.ts` -- all tests pass.
Run `npx vitest run --coverage` and check reporter.ts coverage is 90%+.
  </verify>
  <done>
reporter.ts has 15+ passing unit tests covering all formatting functions, error classification branches, diff preview, and content stripping.
reporter.ts coverage is 90%+ on all 4 metrics.
  </done>
</task>

</tasks>

<verification>
After both tasks:
- `npm run build` succeeds (dead code removal didn't break anything)
- `npx vitest run` -- all tests pass (existing + new)
- `npx vitest run --coverage` -- errors.ts and reporter.ts both show 90%+ on lines, branches, functions, statements
</verification>

<success_criteria>
- errors.ts coverage: 50% -> 90%+ (lines, branches, functions, statements)
- reporter.ts coverage: 78% -> 90%+ (lines, branches, functions, statements)
- 5 dead functions removed from reporter.ts
- ~55 new test cases across 2 new test files
- All existing 159 tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/10-coverage-completion/10-01-SUMMARY.md`
</output>
