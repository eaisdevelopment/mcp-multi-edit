---
phase: 10-coverage-completion
plan: 03
type: execute
wave: 2
depends_on: ["10-01", "10-02"]
files_modified:
  - vitest.config.ts
  - tests/unit/validator-branches.test.ts
autonomous: true

must_haves:
  truths:
    - "vitest.config.ts enforces 90% thresholds on lines, functions, branches, statements"
    - "src/index.ts is excluded from coverage measurement"
    - "validator.ts remaining branches (EPERM, ELOOP, default in validateFileExists; invalid_type, invalid_string, default in formatZodErrors) are covered"
    - "npx vitest run --coverage exits 0 (all thresholds met)"
    - "Any remaining gaps below threshold are addressed with targeted tests or documented v8 ignore annotations"
  artifacts:
    - path: "vitest.config.ts"
      provides: "Coverage thresholds and index.ts exclusion"
      contains: "thresholds"
    - path: "tests/unit/validator-branches.test.ts"
      provides: "Tests for remaining uncovered validator branches"
      min_lines: 40
  key_links:
    - from: "vitest.config.ts"
      to: "coverage enforcement"
      via: "thresholds configuration"
      pattern: "thresholds.*lines.*90"
    - from: "tests/unit/validator-branches.test.ts"
      to: "src/core/validator.ts"
      via: "direct import"
      pattern: "import.*from.*validator"
---

<objective>
Configure coverage thresholds, fill remaining validator branch gaps, and ensure all metrics pass 90%.

Purpose: This is the final plan that enforces the 90% threshold in vitest.config.ts and closes any remaining coverage gaps. After Plans 01 and 02, the major gaps (errors.ts, reporter.ts, multi-edit-files.ts) should be closed. This plan addresses the remaining smaller gaps in validator.ts branches and applies v8 ignore annotations to any genuinely unreachable defensive code that remains below threshold.

Output: vitest.config.ts with enforced thresholds, all metrics at 90%+, `npx vitest run --coverage` exits clean.
</objective>

<execution_context>
@/Users/dev/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-coverage-completion/10-RESEARCH.md
@.planning/phases/10-coverage-completion/10-01-SUMMARY.md
@.planning/phases/10-coverage-completion/10-02-SUMMARY.md
@vitest.config.ts
@src/core/validator.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure coverage thresholds and exclude index.ts</name>
  <files>vitest.config.ts</files>
  <action>
Update vitest.config.ts to:

1. Add `src/index.ts` to the `exclude` array (it's a 17-line stdio bootstrap, untestable without mocking process I/O, server creation already tested via createServer in integration tests).

2. Add `thresholds` block inside `coverage`:
```typescript
thresholds: {
  lines: 90,
  functions: 90,
  branches: 90,
  statements: 90,
},
```

The final config should look like:
```typescript
import { defineConfig } from 'vitest/config'

export default defineConfig({
  test: {
    globals: true,
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      exclude: ['node_modules/', 'dist/', 'tests/', 'src/index.ts'],
      thresholds: {
        lines: 90,
        functions: 90,
        branches: 90,
        statements: 90,
      },
    },
  },
})
```

After writing, run `npx vitest run --coverage` to see current state with the exclusion applied. Note which files/metrics are still below 90%.
  </action>
  <verify>
Run `npx vitest run --coverage` and examine the coverage table output. All tests should still pass. Note any metrics still below 90% threshold -- these will be addressed in Task 2.
  </verify>
  <done>
vitest.config.ts has thresholds at 90% for all 4 metrics.
src/index.ts is excluded from coverage.
Coverage report no longer includes src/index.ts in the denominator.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fill remaining validator branches and close any final gaps</name>
  <files>tests/unit/validator-branches.test.ts</files>
  <action>
**Step 1: Run coverage and identify remaining gaps**

Run `npx vitest run --coverage` and note any files still below 90% on any metric. The research identified these validator.ts gaps:

1. **validateFileExists EPERM branch (L128-133):** Test with a file that triggers EPERM error.
   - Use vi.spyOn on the fs module to simulate EPERM. The validator uses `import fs from 'node:fs/promises'` (default import), so per 08-02 decision, use `vi.spyOn(fsModule.default, 'access')` pattern.
   - Actually, validator uses `realpath` not `access`. Check the actual code path for `validateFileExists`.
   - Create test: spy on `fs.realpath` to throw `Object.assign(new Error('op not permitted'), { code: 'EPERM' })`
   - Expect: ValidationError with code 'OPERATION_NOT_PERMITTED'

2. **validateFileExists ELOOP branch (L134-140):**
   - Same pattern but with `{ code: 'ELOOP' }`
   - Expect: ValidationError with code 'SYMLINK_LOOP'

3. **validateFileExists default branch (L141-147):**
   - Same pattern but with `{ code: 'ENXIO' }` (or any unrecognized code)
   - Expect: ValidationError with code 'FILE_ACCESS_ERROR'

4. **formatZodErrors invalid_type branch (L227-228):**
   - Call validateMultiEditInputFull with `{ file_path: 123, edits: [] }` (number instead of string)
   - Expect: error with recovery_hint containing 'Expected'

5. **formatZodErrors invalid_string branch (L230-231):**
   - This is harder to trigger with the current Zod schema (no string format validators like email/url). If the current schema doesn't use `.email()` or `.url()`, this branch may be unreachable.
   - If unreachable: add `/* v8 ignore next 2 */` above the case with comment: `// No string format validators in current schema`

6. **formatZodErrors default branch (L233-234):**
   - Trigger with a custom_error or other non-standard Zod issue type. Try: pass an object where a nested field triggers a `custom` issue.
   - If hard to trigger naturally: this is a defensive catch-all. Add `/* v8 ignore next 2 */` with comment: `// Defensive catch-all for future Zod issue types`

**Step 2: Address any other remaining gaps**

After running coverage with the new validator tests, check if any file is still below 90% on any metric. For each remaining gap:

- If it's testable: add a targeted test
- If it's genuinely unreachable defensive code (e.g., catch blocks that can only fire if a dependency has a bug): add `/* v8 ignore next N */` with a comment explaining why it's unreachable
- Use v8 ignore SPARINGLY -- the research warns against more than 2-3 in the entire codebase

Common candidates for v8 ignore:
- server.ts L164-173 catch block (if not covered by Plan 02's server test)
- editor.ts temp file cleanup catch blocks (defensive cleanup for files that may not exist)

**Step 3: Final verification**

Run `npx vitest run --coverage` one final time. If thresholds are met, the command exits 0. If not, iterate on remaining gaps until all 4 metrics are at 90%+.

Import pattern for validator tests:
```typescript
import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest';
import { validateMultiEditInputFull, formatZodErrors, validateFileExists } from '../../src/core/validator.js';
```

For mocking `node:fs/promises` in validator.ts (per 08-02 decision):
```typescript
vi.mock('node:fs/promises', async () => {
  const actual = await vi.importActual<typeof import('node:fs/promises')>('node:fs/promises');
  return { ...actual, default: { ...actual } };
});
import fs from 'node:fs/promises';
// Then: vi.spyOn(fs, 'realpath').mockRejectedValueOnce(...)
```

Or if validateFileExists is exported and can be tested by mocking at a higher level, do that instead.
  </action>
  <verify>
Run `npx vitest run --coverage` -- exits 0 (all thresholds met).
All 4 metrics (lines, functions, branches, statements) show 90%+ in the summary row.
No file (except excluded index.ts) is below 90% lines.
All tests pass.
  </verify>
  <done>
`npx vitest run --coverage` exits 0 with all thresholds met.
validator.ts EPERM, ELOOP, and default branches are covered.
Any remaining unreachable code is documented with v8 ignore annotations and rationale.
Overall coverage: 90%+ on lines, functions, branches, statements.
  </done>
</task>

</tasks>

<verification>
Final phase verification:
1. `npm run build` -- clean compile
2. `npx vitest run` -- all tests pass (existing + ~65 new)
3. `npx vitest run --coverage` -- exits 0, all thresholds at 90%+
4. Coverage table shows no non-excluded file below 90% lines
5. v8 ignore comments (if any) are each accompanied by a rationale comment
</verification>

<success_criteria>
- vitest.config.ts enforces 90% thresholds on all 4 metrics
- src/index.ts excluded with clear rationale (17-line stdio bootstrap)
- `npx vitest run --coverage` exits 0
- Overall coverage: 90%+ lines, 90%+ functions, 90%+ branches, 90%+ statements
- All v8 ignore annotations (if any) have explanatory comments
- Phase 10 success criteria from ROADMAP.md fully met:
  1. Code coverage report shows 90%+ line coverage
  2. Coverage gaps documented with rationale
  3. CI enforces coverage threshold (builds fail below 90%)
</success_criteria>

<output>
After completion, create `.planning/phases/10-coverage-completion/10-03-SUMMARY.md`
</output>
