---
phase: 07-multi-file-operations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/index.ts
  - src/core/validator.ts
autonomous: true

must_haves:
  truths:
    - "MultiEditFilesInput type includes include_content parameter"
    - "MultiEditFilesResult type includes summary fields (total_files, files_succeeded, files_failed, total_edits)"
    - "MultiEditFilesInputSchema Zod schema includes include_content"
    - "Cross-file duplicate path detection resolves symlinks before comparison"
    - "Multi-file validation pipeline collects ALL errors across ALL files before returning"
    - "Empty files array is rejected with validation error"
    - "Duplicate file paths are rejected listing the duplicates"
  artifacts:
    - path: "src/types/index.ts"
      provides: "Extended MultiEditFilesInput and MultiEditFilesResult types"
      contains: "include_content"
    - path: "src/core/validator.ts"
      provides: "validateMultiEditFilesInputFull pipeline and duplicate path detection"
      exports: ["validateMultiEditFilesInputFull", "detectDuplicateFilePaths"]
  key_links:
    - from: "src/core/validator.ts"
      to: "src/types/index.ts"
      via: "MultiEditFilesInput type import"
      pattern: "MultiEditFilesInput"
---

<objective>
Extend types and build multi-file validation pipeline for Phase 7 multi-file operations.

Purpose: All type extensions and validation logic must exist before the handler can be rewritten. This plan ensures the foundation is solid: types match CONTEXT decisions, Zod schema includes include_content, and a comprehensive multi-file validation pipeline collects all errors upfront (cross-file duplicate paths, per-file path validation, per-file existence, per-file duplicate old_strings).

Output: Extended types in `src/types/index.ts`, extended Zod schema and new `validateMultiEditFilesInputFull()` function in `src/core/validator.ts`.
</objective>

<execution_context>
@/Users/dev/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-multi-file-operations/07-CONTEXT.md
@.planning/phases/07-multi-file-operations/07-RESEARCH.md
@src/types/index.ts
@src/core/validator.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend types and Zod schema for multi-file operations</name>
  <files>src/types/index.ts, src/core/validator.ts</files>
  <action>
In `src/types/index.ts`:

1. Add `include_content?: boolean` to `MultiEditFilesInput` interface (mirrors single-file `MultiEditInput`).

2. Add a `summary` field to `MultiEditFilesResult`:
```typescript
summary?: {
  total_files: number;
  files_succeeded: number;
  files_failed: number;
  total_edits: number;
};
```

3. Add `RollbackDetail` and `RollbackReport` types for rollback reporting:
```typescript
interface RollbackDetail {
  file_path: string;
  status: 'restored' | 'failed';
  backup_path: string;
  error?: string;
}

interface RollbackReport {
  files_rolled_back: number;
  files_failed_rollback: number;
  details: RollbackDetail[];
}
```

4. Add `rollback?: RollbackReport` to `MultiEditFilesResult`.

5. Add `'DUPLICATE_FILE_PATH'` to the `ErrorCode` union type (it's a validation error, retryable).

In `src/core/validator.ts`:

1. Add `include_content: z.boolean().optional().default(false)` to `MultiEditFilesInputSchema`.

In `src/core/errors.ts`:

1. Add `'DUPLICATE_FILE_PATH'` to `RETRYABLE_CODES` set.
2. Add case for `'DUPLICATE_FILE_PATH'` in `getRecoveryHints()` returning `['Remove duplicate file paths from the files array', 'Each file should appear only once']`.

Do NOT change any existing field names or remove existing fields. These are all additive changes.
  </action>
  <verify>Run `npm run build` — TypeScript compilation succeeds with no errors.</verify>
  <done>Types include summary, include_content, RollbackReport, DUPLICATE_FILE_PATH error code. Zod schema includes include_content. Build passes.</done>
</task>

<task type="auto">
  <name>Task 2: Build multi-file validation pipeline with cross-file duplicate detection</name>
  <files>src/core/validator.ts</files>
  <action>
Create two new exported functions in `src/core/validator.ts`:

**1. `detectDuplicateFilePaths(files: Array<{ file_path: string }>): Promise<ValidationError[]>`**

Purpose: Detect duplicate file paths across the files array, resolving symlinks first for accurate comparison.

Logic:
- For each file in the array, call `validateFileExists()` to get the resolved path (symlink-resolved).
- If `validateFileExists()` fails for a file, skip that file for duplicate detection (it will be caught by the existence check later).
- Build a Map of resolved_path -> first_occurrence_index.
- For each subsequent occurrence of the same resolved path, create a `ValidationError` with:
  - `code: 'DUPLICATE_FILE_PATH'`
  - `message: 'Duplicate file path: "{file_path}" resolves to same location as files[{first_index}]'`
  - `path: ['files', String(duplicate_index), 'file_path']`
  - `recovery_hint: 'Remove duplicate file paths — each file should appear only once'`
- Return array of all duplicate errors.

**2. `validateMultiEditFilesInputFull(input: unknown): Promise<ValidationResult<MultiEditFilesInput>>`**

Purpose: Full 5-layer validation pipeline for multi-file input. Collects ALL errors before returning.

Layers (order matters — fastest/cheapest first):

Layer 1 — Zod schema validation:
- Call `MultiEditFilesInputSchema.safeParse(input)`
- If fails, convert with `formatZodErrors()` and return `{ success: false, errors }`

Layer 2 — Per-file path validation:
- Loop over all files, call `validatePath(file.file_path)` on each
- Collect all errors (don't stop on first)
- Prefix the error path: `['files', String(i), 'file_path']`

Layer 3 — Cross-file duplicate path detection:
- Call `detectDuplicateFilePaths(data.files)`
- Collect errors

Layer 4 — Per-file existence check:
- Loop over all files, call `validateFileExists(file.file_path)` on each
- Collect all errors, prefixing path: `['files', String(i), 'file_path']`
- For files that DO exist, store the resolved path

Layer 5 — Per-file duplicate old_string detection:
- Loop over all files, call `detectDuplicateOldStrings(file.edits)` on each
- Prefix paths: `['files', String(i), ...]`
- Collect all errors

After Layers 2-5: If ANY errors were collected, return `{ success: false, errors: allErrors }` (all errors from all layers combined).

If all pass: Return `{ success: true, data }` with file_paths replaced by their resolved paths from Layer 4.

Import the `MultiEditFilesInput` type and use the existing `ValidationResult<T>` generic.

IMPORTANT: Layers 2-5 are combined — run all of them and collect errors before returning. Only Layer 1 (Zod) is a hard stop because subsequent layers need parsed data.
  </action>
  <verify>Run `npm run build` — TypeScript compilation succeeds. Verify the two new functions are exported by checking `grep -n "export.*detectDuplicateFilePaths\|export.*validateMultiEditFilesInputFull" src/core/validator.ts`.</verify>
  <done>Both `detectDuplicateFilePaths` and `validateMultiEditFilesInputFull` are exported and compile. The validation pipeline collects all errors across all files before returning. Duplicate file paths are detected after symlink resolution.</done>
</task>

</tasks>

<verification>
1. `npm run build` passes with zero TypeScript errors
2. `MultiEditFilesInput` type in `src/types/index.ts` has `include_content?: boolean`
3. `MultiEditFilesResult` type has `summary` and `rollback` fields
4. `RollbackDetail` and `RollbackReport` types exist
5. `DUPLICATE_FILE_PATH` is in the `ErrorCode` union
6. `MultiEditFilesInputSchema` includes `include_content`
7. `validateMultiEditFilesInputFull()` is exported from `src/core/validator.ts`
8. `detectDuplicateFilePaths()` is exported from `src/core/validator.ts`
</verification>

<success_criteria>
- All new types compile and are importable
- Multi-file validation pipeline collects all errors before returning
- Cross-file duplicate path detection uses symlink resolution
- No existing functionality is broken (build passes)
</success_criteria>

<output>
After completion, create `.planning/phases/07-multi-file-operations/07-01-SUMMARY.md`
</output>
